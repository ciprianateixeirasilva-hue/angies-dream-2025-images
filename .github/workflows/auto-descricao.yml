name: Auto-Descricao-24x7

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      BRANCH: main
      IMAGES_DIR: images
      OUTPUTS_DIR: outputs
      STATE_DIR: .state
      STATE_FILE: .state/processed.json
      MIN_GAP_MINUTES: "190"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai==1.51.0 requests==2.32.3

      - name: Create worker script
        run: |
          mkdir -p "$STATE_DIR" "$OUTPUTS_DIR"
          cat > worker.py << 'PY'
# ---------------- SCRIPT PYTHON ----------------
import os, json, datetime, glob
from pathlib import Path
import requests
from openai import OpenAI

def now_utc():
    return datetime.datetime.utcnow()

def iso(dt):
    return dt.strftime("%Y-%m-%d_%H-%M")

def iso_full(dt):
    return dt.strftime("%Y-%m-%dT%H:%M:%SZ")

REPO        = os.environ["REPO"]
BRANCH      = os.environ.get("BRANCH", "main")
IMAGES_DIR  = os.environ.get("IMAGES_DIR", "images")
OUTPUTS_DIR = os.environ.get("OUTPUTS_DIR", "outputs")
STATE_DIR   = os.environ.get("STATE_DIR", ".state")
STATE_FILE  = os.environ.get("STATE_FILE", ".state/processed.json")
MIN_GAP     = int(os.environ.get("MIN_GAP_MINUTES", "190"))

Path(STATE_DIR).mkdir(parents=True, exist_ok=True)

if os.path.exists(STATE_FILE):
    with open(STATE_FILE, "r", encoding="utf-8") as f:
        state = json.load(f)
else:
    state = {"processed": [], "last_cycle_finished_at": None}

processed = set(state.get("processed", []))
last_done = state.get("last_cycle_finished_at")

if last_done:
    last_str = last_done.replace("Z", "")
    try:
        last_dt = datetime.datetime.fromisoformat(last_str)
    except:
        last_dt = datetime.datetime.strptime(last_done, "%Y-%m-%dT%H:%M:%SZ")
    delta_min = (now_utc() - last_dt).total_seconds() / 60.0
    if delta_min < MIN_GAP:
        print("Skip cycle: too soon.")
        raise SystemExit(0)

imgs = sorted([p for p in glob.glob(f"{IMAGES_DIR}/*") if os.path.isfile(p)])
unprocessed = [os.path.basename(p) for p in imgs if os.path.basename(p) not in processed]

if not unprocessed:
    print("No new images.")
    raise SystemExit(0)

client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

ts = iso(now_utc())
out_path = Path(OUTPUTS_DIR) / f"output-descricoes-{ts}.txt"
Path(OUTPUTS_DIR).mkdir(parents=True, exist_ok=True)

PONTO1 = (
    "1. Usando a minha imagem, Recrie essa mesma imagem, porÃ©m melhorando a qualidade "
    "para camera profissional 8k HD, hiper-realistic, sem mudar caracteristicas fisicas "
    "ou corpo, apenas removendo granulacao."
)

ESTRUTURA = (
    PONTO1 + "\n"
    "2. Cabelo...\n"
    "3. Corpo e Pose...\n"
    "4. Roupas...\n"
    "5. Calcado...\n"
    "6. Acessorios...\n"
    "7. Ambiente e Fundo...\n"
    "8. Coloracao Realista...\n"
    "9. Estilo e Intencao Visual...\n"
    "10. Tipo de Plano...\n"
    "11. Angulo da Camara...\n"
    "12. Tatuagens...\n"
    "13. Animal...\n"
    "14. Prompt...\n"
)

raw_base = f"https://raw.githubusercontent.com/{REPO}/{BRANCH}/{IMAGES_DIR}"
results = []

for fname in unprocessed:
    url = f"{raw_base}/{requests.utils.quote(fname)}"
    msg = [
        {"role": "system", "content": "Assistente de moda."},
        {"role": "user", "content": f"FILENAME: {fname}\nImagem: {url}\n{ESTRUTURA}"}
    ]
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=msg
        )
        text = resp.choices[0].message.content.strip()
    except Exception as e:
        text = f"ERRO: {e}"

    results.append(f"{fname}\n{text}\n")
    processed.add(fname)

with open(out_path, "w", encoding="utf-8") as f:
    f.write("\n".join(results))

state["processed"] = sorted(processed)
state["last_cycle_finished_at"] = iso_full(now_utc())

with open(STATE_FILE, "w", encoding="utf-8") as f:
    json.dump(state, f, indent=2, ensure_ascii=False)

# ---------------- FIM PYTHON ----------------
PY

      - name: Run worker
        run: python worker.py

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto update" || echo "Nothing to commit"
          git push
