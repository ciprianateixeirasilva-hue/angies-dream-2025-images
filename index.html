<script>
  // Autodetecta branch e diretório; usa download_url da API (evita 404 de raw)
  const CONFIG = {
    owner:  "ciprianateixeirasilva-hue",
    repo:   "angies-dream-2025-images",
    branches: ["main","master"],
    dirs:     ["imagens","images"],
  };

  function apiUrl(branch, dir){
    return `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${dir}?ref=${branch}`;
  }

  async function listDir(branch, dir){
    const res = await fetch(apiUrl(branch, dir), { headers: { 'Accept': 'application/vnd.github+json' }});
    if (!res.ok) return { files: [], branch, dir, status: res.status, err: await res.text() };
    const data = await res.json();
    const allowed = [".jpg",".jpeg",".png",".webp",".gif"];
    const files = (data||[])
      .filter(x => x.type === "file" && x.download_url && allowed.some(ext => x.name.toLowerCase().endsWith(ext)))
      .map(x => ({ name: x.name, url: x.download_url, size: x.size }));
    return { files, branch, dir, status: 200 };
  }

  async function discover(){
    for (const branch of CONFIG.branches){
      for (const dir of CONFIG.dirs){
        const { files } = await listDir(branch, dir);
        if (files.length) return { files, branch, dir };
      }
    }
    return { files: [], branch: null, dir: null };
  }

  function humanSize(bytes){
    if(bytes < 1024) return `${bytes} B`;
    const u = ["KB","MB","GB"]; let i=-1;
    do{bytes/=1024;i++;}while(bytes>=1024 && i<u.length-1);
    return `${bytes.toFixed(bytes<10?2:1)} ${u[i]}`;
  }
  function naturalCompare(a,b){ return a.localeCompare(b, undefined, { numeric:true, sensitivity:"base" }); }

  function render(list){
    const grid = document.querySelector(".grid");
    const q = (document.querySelector("#q")?.value||"").trim().toLowerCase();
    const sort = document.querySelector("#sort")?.value || "az";

    let items = list.slice();
    if(q) items = items.filter(it => it.name.toLowerCase().includes(q));
    if(sort==="az")   items.sort((a,b)=>naturalCompare(a.name,b.name));
    if(sort==="za")   items.sort((a,b)=>naturalCompare(b.name,a.name));
    if(sort==="small")items.sort((a,b)=>a.size-b.size);
    if(sort==="big")  items.sort((a,b)=>b.size-a.size);

    grid.innerHTML = "";
    if(!items.length){ grid.innerHTML = `<div class="empty">Sem resultados. Confirma que há ficheiros em <code>/imagens</code> ou <code>/images</code> nas branches <code>main</code> ou <code>master</code>.</div>`; return; }

    for(const it of items){
      const card = document.createElement("a");
      card.className = "card";
      card.href = it.url;
      card.target = "_blank";
      card.rel = "noopener noreferrer";
      card.innerHTML = `
        <img class="thumb" loading="lazy" src="${it.url}" alt="${it.name}" />
        <div class="meta">
          <div class="name" title="${it.name}">${it.name}</div>
          <div class="size">${humanSize(it.size)}</div>
        </div>`;
      grid.appendChild(card);
    }
    document.querySelector("#count")?.textContent = `${items.length} ficheiro(s)`;
  }

  function showBadge(branch, dir){
    const wrap = document.querySelector("header .wrap");
    if (!wrap) return;
    const b = document.createElement("span");
    b.className = "badge";
    b.style.marginLeft = "8px";
    b.textContent = branch && dir ? `Fonte: ${branch} / ${dir}` : "Fonte: não encontrada";
    wrap.querySelector("h1")?.appendChild(b);
  }

  let CACHE = [];
  async function init(){
    try{
      const { files, branch, dir } = await discover();
      showBadge(branch, dir);
      CACHE = files;
      render(CACHE);
    }catch(err){
      console.error(err);
      document.querySelector(".grid").innerHTML = `<div class="empty">${err.message}</div>`;
    }
  }

  window.addEventListener("DOMContentLoaded", ()=>{
    document.querySelector("#q")?.addEventListener("input", ()=>render(CACHE));
    document.querySelector("#sort")?.addEventListener("change", ()=>render(CACHE));
    init();
  });
</script>
