      - name: Create worker script
        shell: bash
        run: |
          mkdir -p "$STATE_DIR" "$OUTPUTS_DIR"
          cat > worker.py << 'PY'
import os, json, datetime, glob, sys
from pathlib import Path
import requests
from openai import OpenAI

# --- helpers ---
def now_utc():
    return datetime.datetime.utcnow()

def iso(dt):
    return dt.strftime("%Y-%m-%d_%H-%M")

def iso_full(dt):
    return dt.strftime("%Y-%m-%dT%H:%M:%SZ")

# --- env ---
REPO = os.environ["REPO"]
BRANCH = os.environ.get("BRANCH", "main")
IMAGES_DIR = os.environ.get("IMAGES_DIR", "images")
OUTPUTS_DIR = os.environ.get("OUTPUTS_DIR", "outputs")
STATE_DIR = os.environ.get("STATE_DIR", ".state")
STATE_FILE = os.environ.get("STATE_FILE", ".state/processed.json")
MIN_GAP = int(os.environ.get("MIN_GAP_MINUTES", "190"))
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")

if not OPENAI_API_KEY:
    print("ERRO: OPENAI_API_KEY não definido nos secrets.")
    sys.exit(1)

# --- state ---
Path(STATE_DIR).mkdir(parents=True, exist_ok=True)
if os.path.exists(STATE_FILE):
    with open(STATE_FILE, "r", encoding="utf-8") as f:
        state = json.load(f)
else:
    state = {"processed": [], "last_cycle_finished_at": None}

processed = set(state.get("processed", []))
last_done = state.get("last_cycle_finished_at")

# respeita intervalo mínimo
if last_done:
    s = last_done.replace("Z", "")
    try:
        last_dt = datetime.datetime.strptime(s, "%Y-%m-%dT%H:%M:%S")
    except Exception:
        last_dt = datetime.datetime.fromisoformat(s)
    delta_min = (now_utc() - last_dt).total_seconds() / 60.0
    if delta_min < MIN_GAP:
        print(f"SKIP: só passaram {delta_min:.1f} min (< {MIN_GAP}).")
        sys.exit(0)

# filtra apenas extensões de imagem
VALID_EXT = {".jpg", ".jpeg", ".png", ".webp"}
imgs = sorted(
    p for p in glob.glob(f"{IMAGES_DIR}/*")
    if os.path.isfile(p) and os.path.splitext(p)[1].lower() in VALID_EXT
)
unprocessed = [os.path.basename(p) for p in imgs if os.path.basename(p) not in processed]

if not unprocessed:
    print("Nada novo para processar.")
    sys.exit(0)

client = OpenAI(api_key=OPENAI_API_KEY)

ts = iso(now_utc())
out_path = Path(OUTPUTS_DIR) / f"output-descricoes-{ts}.txt"
Path(OUTPUTS_DIR).mkdir(parents=True, exist_ok=True)

# ---- PONTO 1 (texto exato, centralizado) ----
PONTO1_TEXTO_EXATO = (
    "1. Usando a minha imagem, Recrie essa mesma imagem, porém melhorando a sua qualidade, "
    "trazendo para uma câmera profissional 8k HD resolution, hiper-realistic, melhorando apenas a qualidade da imagem. "
    "Retire esse excesso de granulação e deixe mais nítida, como uma cena de filme, sem alterar minhas características físicas, "
    "idade, gênero, sem distorções rosto ou corpo, sem pele plástica, o corpo da mulher é size médium, busto 100 taça C."
)

# ---- ESTRUTURA 15 PONTOS (consistente com o system) ----
ESTRUTURA_15 = f"""{PONTO1_TEXTO_EXATO}
2. Rosto e Expressão: Descreve o rosto com atenção aos traços, expressão e iluminação. Observa o olhar, a direção do rosto, a maquilhagem e a harmonia facial. Realça a textura natural da pele e o equilíbrio entre luz e sombra, mantendo sempre a coloração realista.
3. Cabelo: Descreva tecnicamente o cabelo da pessoa na imagem, detalhando: Cor Base e Reflexos..., Condição Visível..., Acessórios...
4. Corpo e Pose: Postura, orientação do tronco, cabeça, ombros, braços, mãos, pernas, pés, linhas de movimento; tom técnico.
5. Roupas: Peça superior/inferior/única/3ª camada; cor, material, corte, detalhes; coerência/contraste; logos e padrões.
6. Calçado: Tipo, material, cor, bico, salto, sola, fecho, detalhes, eventuais marcas.
7. Acessórios: Tipo/posicionamento, material, cor, estilo, detalhes, tamanho/proporção, marcas.
8. Ambiente e Fundo: Tipo de cenário, elementos, mobiliário/objetos, paleta, iluminação (fonte/qualidade/direção), texturas, profundidade, distância, atmosfera, sensação espacial.
9. Coloração Realista: Respeitar tons de pele/cabelo/roupa/cenário; equilíbrio luz/sombra.
10. Estilo e Intenção Visual: Ex.: editorial de moda de luxo, retrato artístico, campanha, conceito futurista, cinematográfico.
11. Tipo de Enquadramento: Close-up, Plano Médio, Plano Americano, Corpo Inteiro.
12. Ângulo de Câmara: Normal, Plongée, Contra-Plongée.
13. Tatuagens: Localização, dimensões, estilo, tema, paleta, linework, sombreado, destaques, condição, composição.
14. Animais/Ser: Espécie, coloração/padrões, textura, anatómicos, proporção, pose, condição, movimento/posição, elementos únicos, interação.
15. Prompt (Midjourney): Iniciar com sujeito principal + --style raw --v 5.2; qualidade/realismo; termos por categoria; parâmetros finais: --ar [2:3/16:9] --quality 2 --s 750 --style raw --v 5.2.
"""

def build_messages(img_url, filename):
    system = (
        "És um assistente de direção de arte e moda. "
        "Responde sempre em PT-PT, com a estrutura completa dos 15 pontos, sem simplificar, "
        "mantendo o ponto 1 exatamente como está escrito."
    )
    user = [
        {"type":"text","text": f"FILENAME: {filename}"},
        {"type":"image_url","image_url":{"url": img_url}},
        {"type":"text","text": ESTRUTURA_15}
    ]
    return system, user

raw_base = f"https://raw.githubusercontent.com/{REPO}/{BRANCH}/{IMAGES_DIR}"
results = []
processed_now = []

for fname in unprocessed:
    img_url = f"{raw_base}/{requests.utils.quote(fname)}"
    system, user = build_messages(img_url, fname)
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            temperature=0.3,
            messages=[
                {"role":"system","content":system},
                {"role":"user","content":user}
            ]
        )
        text = resp.choices[0].message.content.strip()
    except Exception as e:
        text = f"[ERRO ao gerar descrição para {fname}: {e}]"

    block = f"{fname}\n{text}\n\n"
    results.append(block)
    processed.add(fname)
    processed_now.append(fname)

with open(out_path, "w", encoding="utf-8") as f:
    f.write("\n".join(results).strip() + "\n")
print(f"Escrito: {out_path} (itens: {len(processed_now)})")

state["processed"] = sorted(processed)
state["last_cycle_finished_at"] = iso_full(now_utc())
with open(STATE_FILE, "w", encoding="utf-8") as f:
    json.dump(state, f, ensure_ascii=False, indent=2)
PY
