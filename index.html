<script>
  // CONFIG — usa "imagens" (PT) e também tenta "images" (EN) como fallback
  const CONFIG = {
    repoOwner: "ciprianateixeirasilva-hue",
    repoName:  "angies-dream-2025-images",
    branch:    "main",
    imagesDir: "imagens" // <- tua pasta atual
  };

  const ALT_DIRS = [CONFIG.imagesDir, "images"]; // tenta as duas

  function apiUrl(dir){
    return `https://api.github.com/repos/${CONFIG.repoOwner}/${CONFIG.repoName}/contents/${dir}?ref=${CONFIG.branch}`;
  }
  function rawUrl(dir, name){
    return `https://raw.githubusercontent.com/${CONFIG.repoOwner}/${CONFIG.repoName}/${CONFIG.branch}/${dir}/${encodeURIComponent(name)}`;
  }

  async function listDir(dir){
    const res = await fetch(apiUrl(dir), { headers: { 'Accept': 'application/vnd.github+json' }});
    if (!res.ok) return [];
    const data = await res.json();
    const allowed = [".jpg",".jpeg",".png",".webp",".gif"];
    return (data||[])
      .filter(x => x.type === "file" && allowed.some(ext => x.name.toLowerCase().endsWith(ext)))
      .map(x => ({ name: x.name, url: rawUrl(dir, x.name), size: x.size }));
  }

  async function fetchAll(){
    // Tenta primeiro a pasta definida, depois a alternativa
    for (const dir of ALT_DIRS){
      const files = await listDir(dir);
      if (files.length) return files;
    }
    return [];
  }

  function humanSize(bytes){
    if(bytes < 1024) return `${bytes} B`;
    const units=["KB","MB","GB"]; let u=-1;
    do{bytes/=1024;u++;}while(bytes>=1024&&u<units.length-1);
    return `${bytes.toFixed(bytes<10?2:1)} ${units[u]}`;
  }
  function naturalCompare(a,b){
    return a.localeCompare(b, undefined, { numeric:true, sensitivity:"base" });
  }

  function render(list){
    const grid = document.querySelector(".grid");
    const q = (document.querySelector("#q")?.value||"").trim().toLowerCase();
    const sort = document.querySelector("#sort")?.value || "az";

    let items = list.slice();
    if(q) items = items.filter(it => it.name.toLowerCase().includes(q));
    if(sort === "az") items.sort((a,b)=>naturalCompare(a.name,b.name));
    if(sort === "za") items.sort((a,b)=>naturalCompare(b.name,a.name));
    if(sort === "small") items.sort((a,b)=>a.size-b.size);
    if(sort === "big") items.sort((a,b)=>b.size-a.size);

    grid.innerHTML = "";
    if(!items.length){
      grid.innerHTML = `<div class="empty">Sem resultados. Confirma que as imagens estão em <code>/imagens</code> ou <code>/images</code>.</div>`;
      return;
    }

    for(const it of items){
      const card = document.createElement("a");
      card.className = "card";
      card.href = it.url;
      card.target = "_blank";
      card.rel = "noopener noreferrer";
      card.innerHTML = `
        <img class="thumb" loading="lazy" src="${it.url}" alt="${it.name}" />
        <div class="meta">
          <div class="name" title="${it.name}">${it.name}</div>
          <div class="size">${humanSize(it.size)}</div>
        </div>`;
      grid.appendChild(card);
    }

    const counter = document.querySelector("#count");
    if (counter) counter.textContent = `${items.length} ficheiro(s)`;
  }

  let CACHE = [];
  async function init(){
    try{
      CACHE = await fetchAll();
      render(CACHE);
    }catch(err){
      console.error(err);
      document.querySelector(".grid").innerHTML = `<div class="empty">${err.message}</div>`;
    }
  }

  window.addEventListener("DOMContentLoaded", ()=>{
    const q = document.querySelector("#q");
    const s = document.querySelector("#sort");
    q && q.addEventListener("input", ()=>render(CACHE));
    s && s.addEventListener("change", ()=>render(CACHE));
    init();
  });
</script>
