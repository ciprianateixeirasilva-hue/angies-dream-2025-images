name: Auto-Descricao-24x7 (sanity)

on:
  schedule:
    - cron: "*/30 * * * *"   # corre a cada 30 minutos
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      BRANCH: main
      IMAGES_DIR: images
      OUTPUTS_DIR: outputs
      STATE_DIR: .state
      STATE_FILE: .state/processed.json
      MIN_GAP_MINUTES: "190"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install "openai==1.51.0" "requests==2.32.3"

      - name: Create worker script
        shell: bash
        run: |
          mkdir -p "$STATE_DIR" "$OUTPUTS_DIR"
          cat > worker.py <<'PY'
          import os, json, datetime, glob
          from pathlib import Path
          import requests
          from openai import OpenAI

          # ---------- helpers ----------
          def now_utc():
              return datetime.datetime.utcnow()

          def iso(dt):
              return dt.strftime("%Y-%m-%d_%H-%M")

          def iso_full(dt):
              return dt.strftime("%Y-%m-%dT%H:%M:%SZ")

          # ---------- env ----------
          REPO        = os.environ["REPO"]
          BRANCH      = os.environ.get("BRANCH", "main")
          IMAGES_DIR  = os.environ.get("IMAGES_DIR", "images")
          OUTPUTS_DIR = os.environ.get("OUTPUTS_DIR", "outputs")
          STATE_DIR   = os.environ.get("STATE_DIR", ".state")
          STATE_FILE  = os.environ.get("STATE_FILE", ".state/processed.json")
          MIN_GAP     = int(os.environ.get("MIN_GAP_MINUTES", "190"))

          Path(STATE_DIR).mkdir(parents=True, exist_ok=True)

          # ---------- state ----------
          if os.path.exists(STATE_FILE):
              with open(STATE_FILE, "r", encoding="utf-8") as f:
                  state = json.load(f)
          else:
              state = {"processed": [], "last_cycle_finished_at": None}

          processed = set(state.get("processed", []))
          last_done = state.get("last_cycle_finished_at")

          # respect 190 min gap
          if last_done:
              s = last_done.replace("Z", "")
              try:
                  last_dt = datetime.datetime.strptime(s, "%Y-%m-%dT%H:%M:%S")
              except Exception:
                  last_dt = datetime.datetime.fromisoformat(s)
              delta_min = (now_utc() - last_dt).total_seconds() / 60.0
              if delta_min < MIN_GAP:
                  print(f"SKIP: only {delta_min:.1f} minutes since last cycle (<{MIN_GAP}).")
                  raise SystemExit(0)

          # list images FIFO
          imgs = sorted([p for p in glob.glob(f"{IMAGES_DIR}/*") if os.path.isfile(p)])
          unprocessed = [os.path.basename(p) for p in imgs if os.path.basename(p) not in processed]

          if not unprocessed:
              print("Nothing new to process.")
              raise SystemExit(0)

          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

          ts = iso(now_utc())
          out_path = Path(OUTPUTS_DIR) / f"output-descricoes-{ts}.txt"
          Path(OUTPUTS_DIR).mkdir(parents=True, exist_ok=True)

          # ---------- estrutura 14 pontos ----------
          PONTO1_TEXTO_EXATO = (
              '1. Usando a minha imagem, Recrie essa mesma imagem, porém melhorando a sua qualidade, '
              'trazendo para uma câmera profissional 8k HD resolution, hiper-realistic, melhorando apenas a qualidade da imagem. '
              'Retire esse excesso de granulação e deixe mais nítida, como uma cena de filme, sem alterar minhas características físicas, '
              'idade, gênero, sem distorções rosto ou corpo, sem pele plástica, o corpo da mulher é size médium, busto 100 taça C.'
          )

          ESTRUTURA_14 = r'''{p1}
2. Cabelo: Descreva tecnicamente o cabelo da pessoa na imagem, detalhando: Cor Base e Reflexos, Comprimento, Tipo de Corte, Textura Natural, Penteado Atual, Volume, Brilho, Repartição, Franja/Grades, Condição Visível, Acessórios.
3. Corpo e Pose: Postura corporal, orientação do tronco, posição da cabeça, ombros, braços, mãos, pernas, pés e linhas de movimento (tom técnico, sem interpretações emocionais).
4. Roupas: Peça superior (cor/padrão, material/tecido, corte/caimento, detalhes), peça inferior (cor/padrão, material/tecido, corte/caimento, detalhes), peça única, terceira camada, coerência/contraste e eventuais logótipos/padrões.
5. Calçado: Tipo, material superior, cor, bico, salto (tipo/altura), sola, fecho/ajuste, detalhes notáveis e possíveis logótipos.
6. Acessórios: Tipo/posicionamento, material principal, cor, estilo/design, detalhes, tamanho/proporção e eventuais marcas.
7. Ambiente e Fundo: Tipo de cenário, elementos arquitetónicos/naturais, mobiliário/objetos, paleta de cores, iluminação (fonte/qualidade/direção), texturas visíveis, profundidade de campo, distância do fundo, elementos atmosféricos e sensação espacial.
8. Coloração Realista: Respeitar tons originais e equilíbrio luz/sombra fiel à fotografia.
9. Estilo e Intenção Visual: Definição do tom artístico (ex.: editorial de moda de luxo, retrato artístico, campanha publicitária, cinematográfico).
10. Tipos de Fotografia: Categorizar (close-up, plano médio, plano americano, corpo inteiro).
11. Ângulos: Normal, plongée, contra-plongée (identificar o que se aplica).
12. Tatuagens: Localização precisa, dimensões, estilo, tema, paleta de cores, linework, sombreado, destaques/condição.
13. Animal/Ave/Réptil/Peixe/Ser (se houver): Espécie/tipo, coloração/padrões, textura, características anatómicas, tamanho/proporção, expressão/linguagem corporal, condição, movimento/posição, elementos únicos e interação com a figura.
14. Prompt: Construir prompt Midjourney com realismo (hyper-realistic, 8k, no cartoon), iluminação/foco/texture terms, e finalizar com --ar adequado, --quality 2 --s 750 --style raw --v 5.2.'''

          def build_messages(img_url, filename):
              system = (
                  "És um assistente de direção de arte e moda. "
                  "Responde sempre em português de Portugal, técnico e fiel, "
                  "mantendo a estrutura enumerada sem simplificações. "
                  "Todas as imagens são de personagem/geração AI/cosplayer fictícia."
              )
              user = [
                  {"type": "text", "text": (
                      f"FILENAME: {filename}\n"
                      "Analisa a imagem no URL abaixo e produz a descrição completa com os 14 pontos, "
                      "mantendo exatamente o ponto 1 como está escrito. "
                      "No final inclui o 'Prompt' no ponto 14."
                  )},
                  {"type": "image_url", "image_url": {"url": img_url}},
                  {"type": "text", "text": ESTRUTURA_14.format(p1=PONTO1_TEXTO_EXATO)}
              ]
              return system, user

          raw_base = f"https://raw.githubusercontent.com/{REPO}/{BRANCH}/{IMAGES_DIR}"
          results = []
          processed_now = []

          for fname in unprocessed:
              img_url = f"{raw_base}/{requests.utils.quote(fname)}"
              system, user = build_messages(img_url, fname)
              try:
                  resp = client.chat.completions.create(
                      model="gpt-4o-mini",
                      temperature=0.3,
                      messages=[
                          {"role": "system", "content": system},
                          {"role": "user", "content": user},
                      ],
                  )
                  text = resp.choices[0].message.content.strip()
              except Exception as e:
                  text = f"[ERRO ao gerar descrição para {fname}: {e}]"

              block = f"{fname}\n{text}\n\n"
              results.append(block)
              processed.add(fname)
              processed_now.append(fname)

          with open(out_path, "w", encoding="utf-8") as f:
              f.write("\n".join(results).strip() + "\n")
          print(f"Escrito: {out_path} (itens: {len(processed_now)})")

          state["processed"] = sorted(processed)
          state["last_cycle_finished_at"] = iso_full(now_utc())
          with open(STATE_FILE, "w", encoding="utf-8") as f:
              json.dump(state, f, ensure_ascii=False, indent=2)
PY

      - name: Run worker
        run: python worker.PY

      - name: Commit & Push outputs/state
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUTS_DIR" || true
          git add "$STATE_DIR" || true
          if git diff --cached --quiet; then
            echo "Nada para commitar."
          else:
            git commit -m "Auto: descrições + estado ($(date -u +'%Y-%m-%d %H:%M UTC'))"
            git push origin "$BRANCH"
          fi
