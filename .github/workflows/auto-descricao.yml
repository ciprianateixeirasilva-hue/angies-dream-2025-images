        - name: Create worker script
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "$STATE_DIR" "$OUTPUTS_DIR"
          tee worker.py > /dev/null <<'PY'
# -*- coding: utf-8 -*-
import os, json, datetime, glob
from pathlib import Path
import requests
from openai import OpenAI

# --- ENV ---
REPO        = os.environ["REPO"]
BRANCH      = os.environ.get("BRANCH", "main")
IMAGES_DIR  = os.environ.get("IMAGES_DIR", "images")
OUTPUTS_DIR = os.environ.get("OUTPUTS_DIR", "outputs")
STATE_DIR   = os.environ.get("STATE_DIR", ".state")
STATE_FILE  = os.environ.get("STATE_FILE", ".state/processed.json")
MIN_GAP     = int(os.environ.get("MIN_GAP_MINUTES", "190"))

def now_utc():
    return datetime.datetime.utcnow()

def iso(dt):
    return dt.strftime("%Y-%m-%d_%H-%M")

def iso_full(dt):
    return dt.strftime("%Y-%m-%dT%H:%M:%SZ")

# --- Estado ---
Path(STATE_DIR).mkdir(parents=True, exist_ok=True)
if os.path.exists(STATE_FILE):
    with open(STATE_FILE, "r", encoding="utf-8") as f:
        state = json.load(f)
else:
    state = {"processed": [], "last_cycle_finished_at": None}

processed = set(state.get("processed", []))
last_done = state.get("last_cycle_finished_at")

# Respeitar janela de 190 min
if last_done:
    last_str = last_done.replace("Z", "")
    try:
        last_dt = datetime.datetime.fromisoformat(last_str)
    except ValueError:
        last_dt = datetime.datetime.strptime(last_done, "%Y-%m-%dT%H:%M:%SZ")
    delta_min = (now_utc() - last_dt).total_seconds() / 60.0
    if delta_min < MIN_GAP:
        print(f"SKIP: apenas {delta_min:.1f} min desde o último ciclo (<{MIN_GAP}).")
        raise SystemExit(0)

# Listar imagens (FIFO por nome)
imgs = sorted([p for p in glob.glob(f"{IMAGES_DIR}/*") if os.path.isfile(p)])
unprocessed = [os.path.basename(p) for p in imgs if os.path.basename(p) not in processed]

if not unprocessed:
    print("Nada novo para processar.")
    raise SystemExit(0)

# OpenAI client
client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

# Nome do ficheiro de saída
ts = iso(now_utc())
out_path = Path(OUTPUTS_DIR) / f"output-descricoes-{ts}.txt"
Path(OUTPUTS_DIR).mkdir(parents=True, exist_ok=True)

# === Estrutura dos 14 pontos (EXATA) ===
PONTO1_TEXTO_EXATO = (
    "1. Usando a minha imagem, Recrie essa mesma imagem, porém melhorando a sua qualidade, "
    "trazendo para uma câmera profissional 8k HD resolution, hiper-realistic, melhorando apenas a qualidade da imagem. "
    "Retire esse excesso de granulação e deixe mais nítida, como uma cena de filme, sem alterar minhas características físicas, "
    "idade, gênero, sem distorções rosto ou corpo, sem pele plástica, o corpo da mulher é size médium, busto 100 taça C."
)

ESTRUTURA_14 = (
    f"{PONTO1_TEXTO_EXATO}\n"
    "2. Cabelo: Descreva tecnicamente o cabelo da pessoa na imagem, detalhando: Cor Base e Reflexos: (ex: Castanho escuro com reflexos acobreados, Loiro platinado com raiz natural aparente), Comprimento: (ex: Curto na altura do queixo, Médio até os ombros, Longo até a cintura), Tipo de Corte: (ex: Bob assimétrico, Camadas longas, Pixie, Reto), Textura Natural: (ex: Liso escorrido, Ondulado suave, Cacheado definido, Crespo volumoso, com volume, brilho natural), Penteado Atual: (ex: Solto e natural, Coque alto despojado, Rabo de cavalo elegante, Trança espinha de peixe lateral, puxado para trás), Volume: (ex: Alto volume na raiz, Pouco volume, Volume concentrado nas pontas), Brilho: (ex: Alto brilho, Brilho discreto, Acabamento matte), Repartição: (ex: Linha reta ao meio, Linha lateral profunda, Sem repartição visível), Franja/Grades (se houver): (ex: Franja reta, Franja cortina, Grades laterais), Condição Visível: (ex: Fios saudáveis e sedosos, Aparência seca, Pontas duplas perceptíveis). Acessórios: (ex: Tiara, Grampos decorados, Faixa de cabelo, chapéu, boina, lenço, tule, boné, gorro).\n"
    "3. Corpo e Pose: Descreve a postura e o posicionamento corporal com elegância: Postura Corporal: (ex: ereta, curvada, relaxada, tensa), Orientação do Tronco: (ex: levemente inclinado para frente/trás/lados, torcido), Posição da Cabeça: (ex: ligeiramente inclinada, reta, voltada para a câmera/lado, queixo elevado/abaixado), Ombros: (ex: relaxados, tensos, elevados, retraídos), Braços: (ex: relaxados ao lado do corpo, cruzados, dobrados, estendidos - e a posição dos cotovelos), Mãos: (ex: nos bolsos, apoiadas na cintura, gestuais, abertas, fechadas - e a posição dos dedos), Pernas: (ex: juntas, afastadas, cruzadas, uma à frente da outra - e a posição dos joelhos), Pés: (ex: paralelos, um à frente, ponta dos pés, peso em um pé), Linhas de Movimento: Descreva as principais linhas criadas pela pose que sugerem movimento ou estática. Evita interpretações emocionais excessivas: mantém um tom profissional e visual.\n"
    "4. Roupas: Descreva tecnicamente as roupas da pessoa na imagem, detalhando: Peça Superior: (ex: Blusa de seda com decote V, Camisa de algodão Oxford, Suéter de lã merino), Cor/Padrão: (ex: Vermelho vivo, Listras finas, Xadrez tartan), Material/Tecido: (ex: Viscose, Linho, Couro, Denim, látex, vinil, rendas, lantejoulas, cetim, seda, veludo, renda, algodão), Corte/Caimento: (ex: Slim fit, Oversized, Cropped, Godê), Detalhes: (ex: sem mangas, com mangas compridas, gola alta, decote em V, tomara-que-caia, cintura marcada, com fenda, estruturado, fluido, mangas bufantes, gola padre, babados, bordados, transparentes, translúcidos), Peça Inferior: (ex: Calça jeans skinny, Saia midi plissada, mini saia, calção, Bermuda de alfaiataria), Cor/Padrão: (ex: Azul índigo, Floral abstrato, Preto liso), Material/Tecido: (ex: lantejoulas, cetim, seda, veludo, renda, vinil, couro, algodão, jeans, crepe, veludo, lã), Corte/Caimento: (ex: Reta, Evasê, Cenoura, Flare), Detalhes: (ex: Cinto embutido, Bolsos cargo, Fenda lateral), Peça Única: (ex: Vestido longo de festa, Macacão utilitário), Peças de Terceira Camada: (ex: Blazer estruturado, Jaqueta de couro, Sobretudo), Coerência/Contraste: Como as peças se harmonizam ou contrastam. Atenção a logótipos/padrões de grife.\n"
    "5. Calçado: Tipo, estrutura, material, cor, bico, salto (forma/altura), sola, fechos, detalhes e eventuais marcas visíveis.\n"
    "6. Acessórios: Tipo e posicionamento (joias, óculos, cinto, mala, chapéu, etc.), material, cor, estilo/design, detalhes, tamanho/proporção. Atenção a marcas visíveis.\n"
    "7. Ambiente e Fundo: Tipo de cenário (interior/exterior), elementos arquitetónicos/naturais, objetos, paleta cromática, iluminação (fonte/qualidade/direção), texturas, profundidade de campo, distância ao fundo, elementos atmosféricos, sensação espacial.\n"
    "8. Coloração Realista: Respeitar tons originais de pele, cabelo, roupa e cenário; equilíbrio luz/sombra fiel.\n"
    "9. Estilo e Intenção Visual: Classificação do tom (editorial de moda de luxo, retrato artístico, campanha publicitária, cinematográfico, etc.).\n"
    "10. Tipo de Plano: Classificar (close-up, plano médio, plano americano, corpo inteiro).\n"
    "11. Ângulo de Câmara: Normal, plongée, contra-plongée, etc.\n"
    "12. Tatuagens/Elementos Especiais (se existirem): Localização precisa, dimensões, estilo, tema, paleta, linework, sombreado, destaques/condição.\n"
    "13. Animal/Ave/Réptil/Peixe/Ser (se existir): Espécie, coloração/padrões, textura, características anatómicas, tamanho/proporção, linguagem corporal, condição, posição/movimento, elementos únicos.\n"
    "14. Prompt (Midjourney): Em inglês, único e coerente com todos os pontos; incluir termos fotográficos profissionais (hyper-realistic, 8k, ultra detailed, DOF, cinematic lighting, etc.) e parâmetros finais: --ar [2:3/16:9], --quality 2, --s 750, --style raw, --v 5.2.\n"
)

def build_messages(img_url, filename):
    system = ("És um assistente de direção de arte e moda. "
              "Responde sempre em português de Portugal, técnico e fiel, "
              "mantendo a estrutura enumerada sem simplificações. "
              "Todas as imagens são provenientes de personagem/geração AI/cosplayer fictícia.")
    user = [
        {"type": "text", "text": (
            f"FILENAME: {filename}\n"
            "Analisa a imagem no URL abaixo e produz a descrição completa com os 14 pontos, "
            "mantendo exatamente o ponto 1 como está escrito. "
            "No final, inclui o 'Prompt' no ponto 14."
        )},
        {"type": "image_url", "image_url": {"url": img_url}},
        {"type": "text", "text": ESTRUTURA_14}
    ]
    return system, user

raw_base = f"https://raw.githubusercontent.com/{REPO}/{BRANCH}/{IMAGES_DIR}"
results = []
processed_now = []

for fname in unprocessed:
    img_url = f"{raw_base}/{requests.utils.quote(fname)}"
    system, user = build_messages(img_url, fname)
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            temperature=0.3,
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user}
            ]
        )
        text = resp.choices[0].message.content.strip()
    except Exception as e:
        text = f"[ERRO ao gerar descrição para {fname}: {e}]"

    block = f"{fname}\n{text}\n\n"
    results.append(block)
    processed.add(fname)
    processed_now.append(fname)

# Escrever output consolidado
with open(out_path, "w", encoding="utf-8") as f:
    f.write("\n".join(results).strip() + "\n")
print(f"Escrito: {out_path} (itens: {len(processed_now)})")

# Atualizar estado
state["processed"] = sorted(processed)
state["last_cycle_finished_at"] = iso_full(now_utc())
with open(STATE_FILE, "w", encoding="utf-8") as f:
    json.dump(state, f, ensure_ascii=False, indent=2)
PY
       
